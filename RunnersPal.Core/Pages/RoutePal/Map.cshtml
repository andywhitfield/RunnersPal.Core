@page
@model RoutePal.MapModel

<aside>
    <vc:user-nav />
</aside>

<article>
    <h1>Route mapping</h1>
    <p>
        <form name="map" method="post">
        @Html.AntiForgeryToken()
        <input type="hidden" name="points" value="@Model.Points" />
        <div>
        <input type="submit" value="Save" />
        <button>Undo</button>
        <button>Clear</button>
        </div>
        <div>
        Name: <input type="text" name="routename" value="@Model.RouteName" />
        Notes: <textarea name="notes"></textarea>
        </div>
        </form>
    </p>
    <div id="map"></div>
</article>

@section Head {
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.min.css">
<script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.min.js"></script>
}
@section Scripts {
<script type="text/javascript">
    L.LabelOverlay = L.Layer.extend({
        initialize: function(/*LatLng*/ latLng, /*String*/ label, options) {
            this._latlng = latLng;
            this._label = label;
            L.Util.setOptions(this, options);
        },
        options: {
            offset: new L.Point(0, 2)
        },
        onAdd: function(map) {
            this._map = map;
            if (!this._container) {
                this._initLayout();
            }
            map.getPanes().popupPane.appendChild(this._container);
            this._container.innerHTML = this._label;
            map.on('movestart', this._update_start, this);
            map.on('moveend', this._update_end, this);
            this._update_end();
        },
        onRemove: function(map) {
            map.getPanes().popupPane.removeChild(this._container);
            map.off('movestart', this._update_start, this);
            map.off('moveend', this._update_end, this);
        },
        _update_start: function(){
            L.DomUtil.setPosition(this._container, 0);
        },
        _update_end: function() {
            var pos = this._map.latLngToLayerPoint(this._latlng);
            var op = new L.Point(pos.x + this.options.offset.x, pos.y - this.options.offset.y);
            L.DomUtil.setPosition(this._container, op);
        },
        _initLayout: function() {
            this._container = L.DomUtil.create('div', 'leaflet-label-overlay');
        }
    });

    const map = L.map('map');
    
    let mapPointsEl = $('form[name="map"] input[name="points"]');
    let mapPoints = mapPointsEl.val() === '' ? [] : JSON.parse(mapPointsEl.val());
    if ((typeof mapPoints !== 'object') || (typeof mapPoints.length !== 'number') || mapPoints.length === 0) {
        if (!navigator.geolocation) {
            map.setView([54.505, -0.09], 6);
        } else {
            navigator.geolocation.getCurrentPosition(
                function(position) {
                    map.setView([position.coords.latitude, position.coords.longitude], 12);
                },
                function() {
                    map.setView([54.505, -0.09], 6);
                });
        }
    } else {
	    map.fitBounds(L.latLngBounds(mapPoints));
    }
	L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
		maxZoom: 19,
		attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
	}).addTo(map);

    const route = new MapRoute(map, mapPointsEl);
    for (const mapPoint of mapPoints) {
        route.addPoint(mapPoint);
    }

    /*
	const map = L.map('map').setView([51.505, -0.09], 10);
	L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
		maxZoom: 19,
		attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
	}).addTo(map);
	L.marker([51.6, 0.09], {
        alt: 'Start of route',
        title: 'Start of route',
        icon: L.icon({ iconUrl: '/images/pin-start.png', iconAnchor: [11, 36] })
    }).addTo(map);

    var endOfRouteMarker = null;
    var lastPoint = [51.6, 0.09];
	function onMapClick(e) {
        L.polyline([lastPoint, e.latlng], {color: '#d866eb'}).addTo(map);
        lastPoint = e.latlng;

        // an example of how we might do the mile / km markers
        map.addLayer(new L.LabelOverlay(lastPoint, '<span class="rp-distance-marker">1</span>'));

        if (endOfRouteMarker === null) {
            endOfRouteMarker = L.marker(lastPoint, {
                alt: 'End of route',
                title: 'End of route',
                icon: L.icon({ iconUrl: '/images/pin-end.png', iconAnchor: [11, 36] })
            }).addTo(map);
        } else {
            endOfRouteMarker.setLatLng(lastPoint);
        }
	}
	map.on('click', onMapClick);
    */
</script>
}

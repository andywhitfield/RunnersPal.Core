@page
@model RoutePal.MapModel

<aside>
    <vc:user-nav />
</aside>

<article>
    <form name="rp-map" method="post">
    @Html.AntiForgeryToken()
    <input type="hidden" name="points" value="@Model.Points" />
    <input type="hidden" name="distance" value="@Model.Distance" />
    <input type="hidden" name="routeid" value="@Model.RouteId" />
    <h1 class="rp-map-head">Route mapping</h1>
    <div>
    @if (!Model.IsRouteDeleted) {
    <input type="submit" name="save" value="Save" />
    }
    <button type="button" name="undo">Undo</button>
    <button type="button" name="clear">Clear</button>
    @if (Model.RouteId == null && Model.LoadUnsaved == null) {
    <button type="button" name="loadunsaved">Load unsaved route</button>
    }
    @if (Model.RouteId.HasValue && !Model.IsRouteDeleted) {
    <button type="submit" name="delete" value="delete" data-confirm="Are you sure you want to delete this route?">Delete</button>
    }
    @if (Model.IsRouteDeleted) {
    <span class="rp-route-deleted">This route has been deleted</span>
    }
    </div>

    <div class="rp-map-name">
        <label for="rp-map-name">Name:</label>
        <input type="text" id="rp-map-name" name="routename" class="rp-map-name" value="@Model.RouteName" />
        Distance: <span class="rp-map-distance">0</span>
        @if (!Model.IsLoggedIn) {
        <button type="button" name="switchunits">switch to @Model.SwitchToUnit</button>
        }
    </div>
    <div>
        <label for="rp-map-notes">Notes:<br/><small>(optional)</small></label>
        <textarea id="rp-map-notes" name="routenotes" class="rp-map-notes" wrap="off">@Model.RouteNotes</textarea>
    </div>
    </form>
    <div id="map"></div>
</article>

@section Scripts {
<script type="text/javascript">
    const map = L.map('map');

    $().ready(function() {        
        const routeNameEl = $('form[name="rp-map"] input[name="routename"]');
        let mapPointsEl = $('form[name="rp-map"] input[name="points"]');
        @if (Model.RouteId != null) {
        <text>
        console.log('saved route, clearing local storage');
        localStorage.removeItem('map.points');
        localStorage.removeItem('map.name');
        localStorage.removeItem('map.notes');
        </text>
        } else if (Model.LoadUnsaved == true) {
        <text>
        if (localStorage.getItem('map.points'))
            mapPointsEl.val(localStorage.getItem('map.points'));
        if (localStorage.getItem('map.name'))
            routeNameEl.val(localStorage.getItem('map.name'));
        if (localStorage.getItem('map.notes'))
            $('form[name="rp-map"] textarea[name="routenotes"]').val(localStorage.getItem('map.notes'));
        console.log('loading an unsaved route local storage: '+routeNameEl.val());
        </text>
        } else {
        <text>
        if (localStorage.getItem('map.points'))
            $('form[name="rp-map"] button[name="loadunsaved"]').click(function() { window.location = '/routepal/map?loadunsaved=true'; });
        else
            $('form[name="rp-map"] button[name="loadunsaved"]').hide();
        </text>
        }
        let mapPoints = mapPointsEl.val() === '' ? [] : JSON.parse(mapPointsEl.val());
        if ((typeof mapPoints !== 'object') || (typeof mapPoints.length !== 'number') || mapPoints.length === 0) {
            if (!navigator.geolocation) {
                map.setView([54.505, -0.09], 6);
            } else {
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        map.setView([position.coords.latitude, position.coords.longitude], 12);
                    },
                    function() {
                        map.setView([54.505, -0.09], 6);
                    });
            }
        } else {
            map.fitBounds(L.latLngBounds(mapPoints));
        }
        L.DomUtil.addClass(map._container,'crosshair-cursor-enabled');
        L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
        }).addTo(map);

        const distanceFormEl = $('form[name="rp-map"] input[name="distance"]');
        const route = new MapRoute(map, mapPointsEl, distanceFormEl, $('span.rp-map-distance'), '@(await Model.UserUnitsAsync())', @(await Model.UserUnitsMultiplierAsync()));
        for (const mapPoint of mapPoints) {
            route.addPoint(mapPoint);
        }

        const saveBtnEl = $('form[name="rp-map"] input[name="save"]');
        rpUpdateSaveButton();
        route.onChange(rpUpdateSaveButton);
        routeNameEl.on('change input paste keyup', rpUpdateSaveButton);

        $('form[name="rp-map"] button[name="undo"]').click(function() { route.undoLastPoint(); });
        $('form[name="rp-map"] button[name="clear"]').click(function() {
            if (confirm('Are you sure you want to clear this route, removing all points and start/end markers?'))
                route.clearRoute();
        });

        function saveToLocalStorage() {
            console.log('saving route ['+routeNameEl.val()+'] to local storage');
            localStorage.setItem('map.points', mapPointsEl.val());
            localStorage.setItem('map.name', routeNameEl.val());
            localStorage.setItem('map.notes', $('form[name="rp-map"] textarea[name="routenotes"]').val());
        }

        function rpUpdateSaveButton() {
            const isSaveDisabled = !routeNameEl.val() || /^\s*$/.test(routeNameEl.val()) || // no route name
                distanceFormEl.val() === '' || distanceFormEl.val() === '0'; // no points
            saveBtnEl.prop('disabled', isSaveDisabled);

            if (!isSaveDisabled) {
                $('form[name="rp-map"] button[name="loadunsaved"]').hide();
                saveToLocalStorage();
            }
        }

        $('form[name="rp-map"] button[name="switchunits"]').click(function() {
            saveToLocalStorage();
            window.location = '/routepal/map?loadunsaved=true&unit=@Model.SwitchToUnit';
        });
    });
</script>
}

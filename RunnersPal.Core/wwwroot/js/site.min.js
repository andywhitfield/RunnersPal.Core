function rpInitialise(){$(window).resize(function(){$("aside").css("display","");$(".nav-close:visible").length>0&&($(".nav-close").css("display",""),$(".nav-show").css("display",""))});$(".nav-show").click(function(){$("aside").fadeToggle("fast");$(this).hide();$(".nav-close").show()});$(".nav-close").click(function(){$("aside").hide();$(this).hide();$(".nav-show").show()});$("[data-href]").click(function(n){return window.location.href=$(this).attr("data-href"),n.preventDefault(),!1});$("[data-confirm]").click(function(n){if(!confirm($(this).attr("data-confirm")))return n.preventDefault(),!1});$("[data-depends]").each(function(){let t=$(this),n=$(t.attr("data-depends"));if(n.is("input"))n.on("keypress",function(n){if(t.attr("disabled")&&(n.keyCode||n.which)===13)return n.preventDefault(),!1});n.on("change input paste keyup pickmeup-change",function(){let n=$(this).val();t.prop("disabled",n===null||n.match(/^\s*$/)!==null)});n.trigger("change")})}coerceToArrayBuffer=function(n,t){var r,u,i;if(typeof n=="string"){for(n=n.replace(/-/g,"+").replace(/_/g,"/"),r=window.atob(n),u=new Uint8Array(r.length),i=0;i<r.length;i++)u[i]=r.charCodeAt(i);n=u}if(Array.isArray(n)&&(n=new Uint8Array(n)),n instanceof Uint8Array&&(n=n.buffer),!(n instanceof ArrayBuffer))throw new TypeError("could not coerce '"+t+"' to ArrayBuffer");return n};coerceToBase64Url=function(n){var i,r,t;if(Array.isArray(n)&&(n=Uint8Array.from(n)),n instanceof ArrayBuffer&&(n=new Uint8Array(n)),n instanceof Uint8Array){for(i="",r=n.byteLength,t=0;t<r;t++)i+=String.fromCharCode(n[t]);n=window.btoa(i)}if(typeof n!="string")throw new Error("could not coerce to string");return n.replace(/\+/g,"-").replace(/\//g,"_").replace(/=*$/g,"")};L.LabelOverlay=L.Layer.extend({initialize:function(n,t,i){this._latlng=n;this._label=t;L.Util.setOptions(this,i)},options:{offset:new L.Point(0,2)},onAdd:function(n){this._map=n;this._container||this._initLayout();n.getPanes().popupPane.appendChild(this._container);this._container.innerHTML=this._label;n.on("movestart",this._update_start,this);n.on("moveend",this._update_end,this);this._update_end()},onRemove:function(n){n.getPanes().popupPane.removeChild(this._container);n.off("movestart",this._update_start,this);n.off("moveend",this._update_end,this)},_update_start:function(){L.DomUtil.setPosition(this._container,0)},_update_end:function(){var n=this._map.latLngToLayerPoint(this._latlng),t=new L.Point(n.x+this.options.offset.x,n.y-this.options.offset.y);L.DomUtil.setPosition(this._container,t)},_initLayout:function(){this._container=L.DomUtil.create("div","leaflet-label-overlay")}});class MapRoute{constructor(n,t,i,r){var u=this;u._points=[];u._mapPoints=[];u._startMarker=null;u._endMarker=null;u._map=n;u._map.on("click",function(n){u.addPoint(n.latlng)});u._pointsFormElement=t;u._distance=0;u._distanceFormElement=i;u._distanceDisplayElement=r;u._nextDistanceMarker=1;u._changeCallbacks=[];u.updatePointsFormElement()}onChange(n){var t=this;t._changeCallbacks.push(n)}addPoint(n){console.log("adding point @ "+n);var t=this;if(t._startMarker===null){t._startMarker=L.marker(n,{alt:"Start of route",title:"Start of route",icon:L.icon({iconUrl:"/images/pin-start.png",iconAnchor:[11,36]})}).addTo(t._map);t._points.push(n);t.updatePointsFormElement();return}const r=t._points[t._points.length-1],o=L.polyline([r,n],{color:"#d866eb"}).addTo(t._map);let u=[],f=t._distance,i={latitude:r.lat,longitude:r.lng};const e={latitude:n.lat,longitude:n.lng},s=geolib.getRhumbLineBearing(i,e);for(t._distance+=geolib.getDistance(i,e),console.log("route distance: "+t._distance+"m");t._distance>=t._nextDistanceMarker*1e3;){const r=t._nextDistanceMarker*1e3-f;f+=r;const n=geolib.computeDestinationPoint(i,r,s);console.log("new distance marker @ ("+n.latitude+","+n.longitude+")");const e=new L.LabelOverlay([n.latitude,n.longitude],'<span class="rp-distance-marker">'+t._nextDistanceMarker+"<\/span>");t._map.addLayer(e);u.push(e);t._nextDistanceMarker++;i=n}t._endMarker===null?t._endMarker=L.marker(n,{alt:"End of route",title:"End of route",icon:L.icon({iconUrl:"/images/pin-end.png",iconAnchor:[11,36]})}).addTo(map):t._endMarker.setLatLng(n);t._points.push(n);t._mapPoints.push({line:o,markers:u});t.updatePointsFormElement()}undoLastPoint(){var n=this;if(n._mapPoints.length>0){console.log("removing last point");n._points.pop();const t=n._mapPoints.length>0?n._mapPoints.pop():null;if(t!==null){const i={latitude:t.line.getLatLngs()[0].lat,longitude:t.line.getLatLngs()[0].lng},r={latitude:t.line.getLatLngs()[1].lat,longitude:t.line.getLatLngs()[1].lng};n._distance-=geolib.getDistance(i,r);n._nextDistanceMarker-=t.markers.length;console.log("removed "+t.markers.length+" distance markers and reduced distance to "+n._distance);t.line.remove();for(const n of t.markers)n.remove()}n._endMarker!==null&&(n._mapPoints.length===0?(console.log("removing end marker"),n._endMarker.remove(),n._endMarker=null):(console.log("moving end marker to "+n._points[n._points.length-1]),n._endMarker.setLatLng(n._points[n._points.length-1])))}else n._points.pop(),n._startMarker!==null&&(console.log("removing start marker"),n._startMarker.remove(),n._startMarker=null);n.updatePointsFormElement()}clearRoute(){var n=this;n._endMarker!==null&&(n._endMarker.remove(),n._endMarker=null);n._startMarker!==null&&(n._startMarker.remove(),n._startMarker=null);for(const t of n._mapPoints){t.line.remove();for(const n of t.markers)n.remove()}n._points.length=0;n._mapPoints.length=0;n._distance=0;n._nextDistanceMarker=1;n.updatePointsFormElement()}updatePointsFormElement(){var n=this;n._pointsFormElement.val(JSON.stringify(n._points));n._distanceFormElement.val(n._distance);n._distanceDisplayElement.text((n._distance/1e3).toLocaleString(undefined,{maximumFractionDigits:1})+" km");for(const t of n._changeCallbacks)t()}}